emergency_teleport:
  root:
    comment: "Emergency exit if has teleport scroll"
    type: Root
    children:
      - type: Sequence
        children:
          - type: HealthCondition
            params:
              comparator: leq
              value_percent: 30
          - type: HasItem
            params:
              tag: kind:teleport_scroll
              #  TODO say that you are fleeing
          - type: UseItem
            params:
              tag: kind:teleport_scroll

use_heal_potion:
  root:
    comment: "Emergency exit if has teleport scroll"
    type: Root
    children:
      - comment: "Heal if has potion and not at full health"
        type: Sequence
        children:
          - type: HealthCondition
            params:
              comparator: leq
              value_percent: 80
          - type: HasItem
            params:
              tag: kind:health_potion
          - type: UseItem
            params:
              tag: kind:health_potion

flee:
  root:
    comment: "Run away at low health"
    type: Root
    children:
      - type: Sequence
        children:
          - type: HealthCondition
            params:
              comparator: leq
              value_percent: 30
          - type: Flee

equip_item:
  root:
    comment: "Equips a weapon if in vicinity"
    type: Root
    children:
      - type: Selector
        children:
          - type: Sequence
            children:
              - type: BlackboardCondition
                params:
                  comparator: eq
                  key: inventory_full
                  value: False
              - type: Inverter
                children:
                  - type: HasItem
                    params:
                      tag: kind:dagger
              - type: BlackboardCondition
                params:
                  comparator: has
                  key: kind:dagger
                  value: irrelevant
              - type: Selector
                children:
                  - type: MoveToEntity
                    params:
                      to: $kind:dagger
                  - type: PickUpItem
                    params:
                      key: picked_up_equipment_id
          - type: Sequence
            children:
              - type: BlackboardCondition
                params:
                  comparator: has
                  key: picked_up_equipment_id
                  value: irrelevant
              - type: EquipItem
                params:
                  id: $picked_up_equipment_id

melee_attacker:
  root:
    comment: "Melee attacker"
    type: Root
    children:
      - type: Selector
        children:
          - type: Subtree
            params:
              id: emergency_teleport
          - type: Subtree
            params:
              id: use_heal_potion
          - type: Subtree
            params:
              id: flee
          - type: Subtree
            params:
              id: equip_item
          - type: Sequence
            children:
              # once alarmed the agent never calms down
              - comment: "Maybe set alarmed"
                type: ForceSuccess
                children:
                  - type: Sequence
                    children:
                      - type: DistanceToPlayer
                        params:
                          max_dist: 10
                      - type: SeesPlayer
                      - type: WriteToBlackboard
                        params:
                          key: alarmed
                          value: True
              - comment: "If alarmed"
                type: BlackboardCondition
                params:
                  key: alarmed
                  comparator: eq
                  value: True
              - comment: "Alarmed: attack if close enough, else move towards player"
                type: Selector
                children:
                  - comment: "Ranged attack if in range but not too close"
                    type: Sequence
                    children:
                      - type: DistanceToPlayer
                        params:
                          max_dist: 7
                          min_dist: 3
                      - type: SeesPlayer
                      - type: HasItem
                        params:
                          tag: kind:arrow
                          # TODO check that we have the bow equipped and if we don't than do so
                      - type: RangedAttack
                  - comment: "Melee if in close range"
                    type: Sequence
                    children:
                      - type: DistanceToPlayer
                        params:
                          max_dist: 1
                      - type: MeleeAttack
                  - type: DebugFailure
                  - type: MoveTowardsPlayer
          - comment: "Else its calm"
            type: RandomMove

shopkeeper:
  root:
    comment: "Friendly shopkeeper"
    type: Root
    children:
      - type: Sequence
        children:
          - type: LeashedRandomMove
            params:
              radius: 1
              center: $__spawn_location__

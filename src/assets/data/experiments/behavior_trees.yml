emergency_teleport:
  root:
    comment: "Emergency exit if has teleport scroll"
    type: Root
    children:
      - type: Sequence
        children:
          - type: HealthCondition
            params:
              comparator: leq
              value_percent: 30
          - type: HasItem
            params:
              item_kind: teleport_scroll
          - type: UseItem
            params:
              item_kind: teleport_scroll

use_heal_potion:
  root:
    comment: "Emergency exit if has teleport scroll"
    type: Root
    children:
      - comment: "Heal if has potion and not at full health"
        type: Sequence
        children:
          - type: HealthCondition
            params:
              comparator: leq
              value_percent: 80
          - type: HasItem
            params:
              item_kind: health_potion
          - type: UseItem
            params:
              item_kind: health_potion

flee:
  root:
    comment: "Run away at low health"
    type: Root
    children:
      - type: Sequence
        children:
          - type: HealthCondition
            params:
              comparator: leq
              value_percent: 20
          - type: RandomMove

melee_attacker:
  root:
    comment: "Melee attacker"
    type: Root
    children:
      - type: Selector
        children:
          - type: Subtree
            params:
              id: emergency_teleport
          - type: Subtree
            params:
              id: use_heal_potion
          - type: Subtree
            params:
              id: flee
          - type: Sequence
            children:
              # once alarmed the agent never calms down
              - comment: "Maybe set alarmed"
                type: Selector
                children:
                  # bc alarmed agents never calm down,
                  # we don't need to check this subtree once alarmed has been set to True once
                  - comment: "optimization: only run expensive siblings, more precisely line of sight, when not alarmed yet"
                    type: BlackboardCondition
                    params:
                      key: alarmed
                      comparator: has
                      value: "irrelevant"
                  - type: Sequence
                    children:
                      - type: DistanceToPlayer
                        params:
                          max_dist: 10
                      - type: SeesPlayer
                      - type: WriteToBlackboard
                        params:
                          key: alarmed
                          value: True
              - comment: "If alarmed"
                type: BlackboardCondition
                params:
                  key: alarmed
                  comparator: eq
                  value: True
              - comment: "Alarmed: attack if close enough, else move towards player"
                type: Selector
                children:
                  - comment: "Ranged attack if in range but not too close"
                    type: Sequence
                    children:
                      - type: DistanceToPlayer
                        params:
                          max_dist: 10
                          min_dist: 5
                      - type: SeesPlayer
                      - type: RangedAttack
                  - comment: "Melee if in close range"
                    type: Sequence
                    children:
                      - type: DistanceToPlayer
                        params:
                          max_dist: 1
                      - type: MeleeAttack
                  - type: MoveTowardsPlayer
          - comment: "Else its calm"
            type: RandomMove
## naive design
#example0:
#  type: Selector
#  children:
#    - type: Sequence
#      children:
#        - type: Condition
#          condition: blackboard.get('actor').is_alarmed
#        - type: Selector
#          children:
#            - type: Sequence
#              children:
#                - type: Condition
#                  condition: max_distance(blackboard.get('player'), blackboard.get('actor')) <= 1
#                - type: Action
#                  action: MeleeAttack
#                  params:
#                    target: blackboard.get('player')
#            - type: Sequence
#              children:
#                - type: Condition
#                  condition: blackboard.get('actor').inventory.has_ranged_weapon()
#                - type: Sequence
#                  children:
#                    - type: Condition
#                      condition: blackboard.get('actor').inventory.ranged_weapon_equipped()
#                    - type: Action
#                      action: SetBlackboard
#                      params:
#                        key: ranged_weapon_range
#                        value: actor.equipment.ranged_weapon_range
#                    - type: Condition
#                      condition: max_distance(player, actor) <= blackboard.get('ranged_weapon_range')
#                    - type: Action
#                      action: RangedAttack
#                      params:
#                        target: blackboard.get('player')
#            - type: Action
#              data:
#                action: move
#                params:
#                  towards: blackboard.get('player')
#    - type: Action
#      action: wait
